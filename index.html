<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOKO - Korean Product Guide</title>
    <style>
        /* --- Reset & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary-black: #111111;
            --primary-white: #ffffff;
            --accent-gray: #777777;
            --light-gray: #f2f2f2;
            --border-color: #dddddd;
            --hover-color: #e8e8e8;
            --focus-ring: rgba(17, 17, 17, 0.15);
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-white);
            color: var(--primary-black);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Splash Screen --- */
        .splash-screen {
            position: fixed; inset: 0; background: var(--primary-black); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
            gap: 1.5rem;
            color: var(--primary-white);
        }
        .splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-title {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            opacity: 0;
            animation: splashFadeIn 0.8s ease-out 0.3s forwards;
        }
        @keyframes splashFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Home Screen --- */
        .home-screen {
            min-height: 100vh; padding: 2.5rem 1.5rem; display: flex; flex-direction: column;
            align-items: center;
        }
        .header {
            width: 100%;
            max-width: 500px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 4rem;
        }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-text { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em; }
        .lang-btn {
            padding: 0.6rem 1rem;
            background: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            display: flex; align-items: center; gap: 0.4rem;
        }
        .lang-btn:hover { background-color: var(--hover-color); transform: translateY(-1px); }
        .lang-btn:active { transform: translateY(0); background-color: var(--light-gray); }

        .main-content {
            flex: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; gap: 3rem;
            width: 100%; max-width: 500px;
        }
        .welcome-text h1 {
            font-size: clamp(2.2rem, 8vw, 3.2rem);
            font-weight: 800;
            line-height: 1.2;
            letter-spacing: -0.04em;
            margin-bottom: 0.8rem;
        }
        .welcome-text p { font-size: 1.15rem; color: var(--accent-gray); font-weight: 500; }

        .search-options { width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        .search-option {
            background: var(--primary-white);
            border: 2px solid var(--primary-black);
            border-radius: 0;
            padding: 1.5rem;
            display: flex; align-items: center;
            gap: 1rem; cursor: pointer;
            transition: all 0.2s ease-out;
            box-shadow: 4px 4px 0px var(--primary-black);
            position: relative;
        }
        .search-option:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--primary-black); background-color: var(--light-gray); }
        .search-option:active { transform: translate(0, 0); box-shadow: 4px 4px 0px var(--primary-black); }

        .option-icon {
            width: 3.5rem; height: 3.5rem;
            color: var(--primary-black);
            border-radius: 0;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            font-size: 1.5rem;
        }
        .option-info { flex: 1; text-align: left; }
        .option-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; letter-spacing: -0.01em; }
        .option-desc { font-size: 0.9rem; color: var(--accent-gray); line-height: 1.4; font-weight: 400; }

        /* --- Page Transitions (Common) --- */
        .page-slide-up, .page-slide-right {
            position: fixed; inset: 0; background: var(--primary-white); z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.7, 0, 0.3, 1);
            box-shadow: none;
            overflow-y: auto; 
        }
        .page-slide-up { transform: translateY(100%); }
        .page-slide-up.active { transform: translateY(0); }
        .page-slide-right { transform: translateX(100%); }
        .page-slide-right.active { transform: translateX(0); }

        .page-header {
            background: var(--primary-white);
            padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.8rem;
            border-bottom: 2px solid var(--primary-black);
            z-index: 100;
            position: sticky; top: 0;
        }
        .back-btn {
            width: 44px; height: 44px; border-radius: 0;
            background: var(--primary-black); color: var(--primary-white);
            border: none;
            font-size: 1.5rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease-out;
            box-shadow: none;
        }
        .back-btn:hover { background-color: var(--accent-gray); transform: none; }
        .back-btn:active { transform: none; box-shadow: none; }
        .header-title { flex: 1; font-size: 1.1rem; font-weight: 700; text-align: center; margin-right: 2.75rem; }

        /* --- Search Results Page --- */
        .search-input {
            flex: 1; padding: 0.8rem 1.2rem; border: 2px solid var(--primary-black);
            border-radius: 0;
            background: var(--light-gray); font-size: 1rem;
            outline: none; transition: all 0.2s ease-out;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1);
        }
        .search-input:focus { border-color: var(--primary-black); background-color: var(--primary-white); box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1), 0 0 0 3px var(--focus-ring); }

        .results-container { padding: 0.5rem 1.5rem; }
        .result-card {
            background: transparent; border-bottom: 1px solid var(--border-color);
            padding: 1rem 0.5rem; cursor: pointer; transition: background-color 0.15s ease-out;
            position: relative;
        }
        .result-card:last-child { border-bottom: none; }
        .result-card:hover { background-color: var(--light-gray); }
        .result-name { font-size: 1.05rem; font-weight: 600; margin-bottom: 0.2rem; }
        .result-desc { font-size: 0.85rem; color: var(--accent-gray); margin-bottom: 0.4rem; font-weight: 400; }
        .result-company { font-size: 0.8rem; color: var(--accent-gray); opacity: 0.8; font-weight: 400; }

        /* --- Detail Page --- */
        .detail-hero {
            padding: 2rem 1.5rem;
            background: var(--primary-white);
            border-bottom: 2px solid var(--primary-black);
        }
        .detail-title { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .detail-subtitle { font-size: 1rem; color: var(--accent-gray); margin-bottom: 1.5rem; font-weight: 500; }

        .detail-content { padding: 0 1.5rem 2rem; }
        .info-grid {
            display: flex; flex-direction: column; gap: 0; margin: 1.5rem 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .info-item {
            background: transparent; padding: 0.9rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .info-item:last-child { border-bottom: none; }
        .info-label { font-size: 0.9rem; color: var(--accent-gray); font-weight: 500; }
        .info-value { font-size: 0.95rem; font-weight: 600; text-align: right; color: var(--primary-black); }

        .section-title { font-size: 1.2rem; font-weight: 700; margin: 2rem 0 1rem; }
        .section-text { font-size: 0.9rem; color: var(--accent-gray); line-height: 1.6; font-weight: 400; }

        /* --- Scanner Modal --- */
        .scanner-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .scanner-modal.active { display: flex; }
        .barcode-modal-content {
            background: var(--primary-white); border-radius: 0;
            width: 100%; max-width: 500px; margin: 0 auto; overflow: hidden; display: flex; flex-direction: column;
            border: 2px solid var(--primary-black);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
        }
        .barcode-header {
            background: var(--primary-black); padding: 1rem 1.5rem; display: flex;
            align-items: center; justify-content: space-between; color: var(--primary-white);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .close-scan-btn {
            width: 36px; height: 36px; border-radius: 0;
            background: rgba(255,255,255,0.2);
            border: none; color: var(--primary-white); font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        .close-scan-btn:hover { background: rgba(255,255,255,0.3); }
        .scan-title { font-size: 1.1rem; font-weight: 700; flex: 1; text-align: center; margin-right: 2.25rem; }

        .scanner-container { position: relative; background: #000; height: 280px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #scanner-viewport, #scanner-viewport video, #scanner-viewport canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .scan-guide { width: 70%; max-width: 300px; height: 120px; position: relative; border: 2px solid #00FF00; }
        .scan-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #00FF00; animation: scan 2s cubic-bezier(0.5, 0, 0.5, 1) infinite; box-shadow: 0 0 8px #00FF00; }
        @keyframes scan { 0% { transform: translateY(0); } 100% { transform: translateY(118px); } }
        .scan-instruction { position: absolute; bottom: -30px; left: 0; right: 0; text-align: center; color: #00FF00; font-size: 0.9rem; font-weight: 600; text-shadow: 0 0 5px rgba(0,255,0,0.5); }

        .scan-result { background: var(--light-gray); padding: 2rem; text-align: center; display: none; }
        .scan-result.active { display: block; }
        .result-icon { font-size: 3rem; margin-bottom: 1rem; color: #00AA00; }
        .barcode-number { font-size: 1.1rem; font-weight: 700; color: var(--primary-black); margin-bottom: 0.5rem; font-family: 'Roboto Mono', monospace; }
        .product-found { font-size: 1rem; color: var(--accent-gray); font-weight: 500; margin-bottom: 1.5rem; }
        .scan-again-btn {
            padding: 0.8rem 1.5rem; background: var(--primary-black); color: var(--primary-white);
            border: 2px solid var(--primary-black); border-radius: 0;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-out;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
        }
        .scan-again-btn:hover { background-color: var(--accent-gray); color: var(--primary-white); box-shadow: 4px 4px 0px rgba(0,0,0,0.2); }

        .manual-input { padding: 1.5rem; background: var(--light-gray); border-top: 1px solid var(--border-color); }
        .manual-text { font-size: 0.85rem; color: var(--accent-gray); text-align: center; margin-bottom: 0.8rem; font-weight: 500; }
        .barcode-input {
            width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--primary-black); border-radius: 0;
            font-size: 1rem; font-family: 'Roboto Mono', monospace; text-align: center; margin-bottom: 0.8rem; outline: none;
            background-color: var(--primary-white); transition: all 0.2s ease-out;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1);
        }
        .barcode-input:focus { border-color: var(--primary-black); background-color: var(--primary-white); box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1), 0 0 0 3px var(--focus-ring); }
        .search-barcode-btn {
            width: 100%; padding: 0.9rem; background: var(--primary-black); color: var(--primary-white);
            border: 2px solid var(--primary-black); border-radius: 0;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-out;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
        }
        .search-barcode-btn:hover { background-color: var(--accent-gray); color: var(--primary-white); box-shadow: 4px 4px 0px rgba(0,0,0,0.2); }

        /* --- Utility & Feedback --- */
        .loading { text-align: center; padding: 3rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .spinner {
            width: 36px; height: 36px; border: 3px solid var(--border-color);
            border-top-color: var(--primary-black); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 2.5rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--primary-black); color: var(--primary-white); padding: 0.8rem 1.2rem;
            border-radius: 0;
            font-size: 0.9rem; z-index: 10000; opacity: 0; transition: all 0.3s ease-out;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .no-results { text-align: center; padding: 4rem 1.5rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .no-results-icon { font-size: 3.5rem; margin-bottom: 1rem; }

        /* Prevent zoom on mobile inputs */
        @media (max-width: 600px) {
            input[type="text"], input[type="number"] {
                font-size: 16px; 
            }
        }
    </style>
</head>
<body>
    <div class="splash-screen" id="splash">
        <div class="splash-logo">🛍️</div>
        <div class="splash-title">KOKO</div>
    </div>

    <div class="home-screen">
        <div class="header">
            <div class="logo">
                <div style="font-size: 32px;">🛍️</div>
                <div class="logo-text">KOKO</div>
            </div>
            <button class="lang-btn" onclick="toggleLanguage()">
                <span id="langFlag">🇰🇷</span>
                <span id="langCode">KR</span>
            </button>
        </div>

        <div class="main-content">
            <div class="welcome-text">
                <h1 id="appTitle">한국 제품을 쉽게 찾아보세요</h1>
                <p id="appSubtitle">검색 방법을 선택하세요</p>
            </div>

            <div class="search-options">
                <div class="search-option" onclick="openTextSearch()">
                    <div class="option-icon">🔍</div>
                    <div class="option-info">
                        <div class="option-title" id="searchByName">상품명 검색</div>
                        <div class="option-desc" id="searchByNameDesc">이름으로 제품 찾기</div>
                    </div>
                </div>

                <div class="search-option" onclick="openBarcodeScanner()">
                    <div class="option-icon">📊</div>
                    <div class="option-info">
                        <div class="option-title" id="scanBarcode">바코드 스캔</div>
                        <div class="option-desc" id="scanBarcodeDesc">바코드로 정확하게 찾기</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="search-results-page" id="searchResultsPage">
        <div class="search-header">
            <button class="back-btn" onclick="closeSearchResults()">←</button>
            <input type="text" class="search-input" id="searchInput" placeholder="상품명을 입력하세요">
        </div>
        <div class="results-container" id="resultsContainer"></div>
    </div>

    <div class="detail-page" id="detailPage">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetail()">←</button>
            <div style="flex:1; font-size: 18px; font-weight: 700;" id="productDetailTitle">상품 상세</div>
        </div>
        <div class="detail-hero" id="detailHero">🍜</div>
        <div class="detail-content" id="detailContent"></div>
    </div>

    <div class="scanner-modal" id="scannerModal">
        <div class="barcode-modal-content">
            <div class="barcode-header">
                <button class="close-scan-btn" onclick="closeScanner()">✕</button>
                <div class="scan-title" id="barcodeScanTitle">바코드 스캔</div>
            </div>
            <div class="scanner-container">
                <div id="scanner-viewport">
                    <div class="scan-overlay">
                        <div class="scan-guide">
                            <div class="scan-corners">
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
                            </div>
                            <div class="scan-line"></div>
                        </div>
                        <div class="scan-instruction" id="scanInstruction">바코드를 화면 중앙에 맞춰주세요</div>
                    </div>
                </div>
                <div class="scan-result" id="scanResult">
                    <div class="result-icon">✅</div>
                    <div class="barcode-number" id="barcodeNumber"></div>
                    <div class="product-found" id="productFound"></div>
                    <button class="scan-again-btn" id="scanAgainBtn" onclick="restartScanning()">다시 스캔</button>
                </div>
            </div>
            <div class="manual-input">
                <div class="manual-text" id="manualInputText">또는 바코드 번호 직접 입력</div>
                <input type="text" class="barcode-input" id="manualBarcode" placeholder="8801234567890">
                <button class="search-barcode-btn" id="searchBarcodeBtn" onclick="searchByManualBarcode()">검색</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
    const FOOD_API_KEY = 'c320de96f22d4183bd13';
    const FOOD_API_BASE = 'https://openapi.foodsafetykorea.go.kr/api';
    const SERVICE_ID = 'C005';
    
    // 🚨 여기에 실제 발급받은 Google Cloud Translation API 키를 입력하세요.
    const TRANSLATE_API_KEY = 'AIzaSyArr1P7f6JuAL8Xz8ECiHi8WkfbNRn4Z7I';
    
    const PROXY_URL = 'https://api.allorigins.win/raw?url=';
    let currentLang = 'ko';
    let currentProduct = null;

    // 다국어 텍스트 정의
    const translations = {
        ko: {
            appTitle: '한국 제품을 쉽게 찾아보세요',
            appSubtitle: '검색 방법을 선택하세요',
            searchByName: '상품명 검색',
            searchByNameDesc: '이름으로 제품 찾기',
            scanBarcode: '바코드 스캔',
            scanBarcodeDesc: '바코드로 정확하게 찾기',
            searchPlaceholder: '상품명을 입력하세요',
            productDetail: '상품 상세',
            manufacturer: '제조사',
            expiry: '소비기한',
            barcode: '바코드',
            reportNumber: '신고번호',
            manufacturerInfo: '제조사 정보',
            noAddress: '주소 정보 없음',
            searching: '검색 중...',
            noResults: '검색 결과가 없습니다',
            loadingInfo: '정보 로딩 중...',
            errorLoading: '정보를 불러오는 중 오류 발생',
            checkApiSettings: 'Google Cloud API 설정을 확인해주세요.',
            barcodeTitle: '바코드 스캔',
            barcodeInstruction: '바코드를 화면 중앙에 맞춰주세요',
            manualInput: '또는 바코드 번호 직접 입력',
            search: '검색',
            scanAgain: '다시 스캔',
            searching_product: '제품 검색 중...',
            product_found: '찾았습니다!',
            product_not_found: '제품을 찾을 수 없습니다',
            error_occurred: '오류가 발생했습니다',
            camera_error: '카메라를 사용할 수 없습니다.',
            invalid_barcode: '올바른 바코드 번호를 입력해주세요',
            translation_needed: '번역 기능 사용을 위해 API 키가 필요합니다.'
        },
        en: {
            appTitle: 'Easily Find Korean Products',
            appSubtitle: 'Choose your search method',
            searchByName: 'Search by Name',
            searchByNameDesc: 'Find products by name',
            scanBarcode: 'Scan Barcode',
            scanBarcodeDesc: 'Find accurately with barcode',
            searchPlaceholder: 'Enter product name',
            productDetail: 'Product Details',
            manufacturer: 'Manufacturer',
            expiry: 'Expiry',
            barcode: 'Barcode',
            reportNumber: 'Report No.',
            manufacturerInfo: 'Manufacturer Info',
            noAddress: 'No address information',
            searching: 'Searching...',
            noResults: 'No search results',
            loadingInfo: 'Loading information...',
            errorLoading: 'Error loading information',
            checkApiSettings: 'Please check Google Cloud API settings.',
            barcodeTitle: 'Barcode Scanner',
            barcodeInstruction: 'Align barcode to center of screen',
            manualInput: 'Or enter barcode number manually',
            search: 'Search',
            scanAgain: 'Scan Again',
            searching_product: 'Searching product...',
            product_found: 'Found!',
            product_not_found: 'Product not found',
            error_occurred: 'An error occurred',
            camera_error: 'Camera not available.',
            invalid_barcode: 'Please enter a valid barcode number',
            translation_needed: 'API key required for translation feature.'
        },
        ja: {
            appTitle: '韓国製品を簡単に検索',
            appSubtitle: '検索方法を選択してください',
            searchByName: '商品名検索',
            searchByNameDesc: '名前で製品を検索',
            scanBarcode: 'バーコードスキャン',
            scanBarcodeDesc: 'バーコードで正確に検索',
            searchPlaceholder: '商品名を入力してください',
            productDetail: '商品詳細',
            manufacturer: 'メーカー',
            expiry: '消費期限',
            barcode: 'バーコード',
            reportNumber: '申告番号',
            manufacturerInfo: 'メーカー情報',
            noAddress: '住所情報なし',
            searching: '検索中...',
            noResults: '検索結果がありません',
            loadingInfo: '情報読み込み中...',
            errorLoading: '情報の読み込み中にエラーが発生',
            checkApiSettings: 'Google Cloud API設定を確認してください。',
            barcodeTitle: 'バーコードスキャン',
            barcodeInstruction: 'バーコードを画面中央に合わせてください',
            manualInput: 'またはバーコード番号を直接入力',
            search: '検索',
            scanAgain: 'もう一度スキャン',
            searching_product: '製品検索中...',
            product_found: '見つかりました！',
            product_not_found: '製品が見つかりません',
            error_occurred: 'エラーが発生しました',
            camera_error: 'カメラが使用できません。',
            invalid_barcode: '正しいバーコード番号を入力してください',
            translation_needed: '翻訳機能にはAPIキーが必要です。'
        }
    };

    // 현재 언어의 텍스트 가져오기
    function getText(key) {
        return translations[currentLang][key] || translations['ko'][key] || key;
    }

    // UI 텍스트 업데이트
    function updateUITexts() {
        document.getElementById('appTitle').textContent = getText('appTitle');
        document.getElementById('appSubtitle').textContent = getText('appSubtitle');
        document.getElementById('searchByName').textContent = getText('searchByName');
        document.getElementById('searchByNameDesc').textContent = getText('searchByNameDesc');
        document.getElementById('scanBarcode').textContent = getText('scanBarcode');
        document.getElementById('scanBarcodeDesc').textContent = getText('scanBarcodeDesc');
        document.getElementById('searchInput').placeholder = getText('searchPlaceholder');
        document.getElementById('productDetailTitle').textContent = getText('productDetail');
        document.getElementById('barcodeScanTitle').textContent = getText('barcodeTitle');
        document.getElementById('scanInstruction').textContent = getText('barcodeInstruction');
        document.getElementById('manualInputText').textContent = getText('manualInput');
        document.getElementById('searchBarcodeBtn').textContent = getText('search');
        document.getElementById('scanAgainBtn').textContent = getText('scanAgain');
    }

    // --- 초기화 및 UI 관련 함수 ---
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            document.getElementById('splash').classList.add('fade-out');
            setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
        }, 1500);
    });

    function toggleLanguage() {
        const langs = ['ko', 'en', 'ja'];
        const flags = { ko: '🇰🇷', en: '🇺🇸', ja: '🇯🇵' };
        const codes = { ko: 'KR', en: 'EN', ja: 'JP' };
        
        const idx = langs.indexOf(currentLang);
        const nextLang = langs[(idx + 1) % langs.length];

        console.log('언어 변경:', currentLang, '->', nextLang);

        if (nextLang !== 'ko' && (!TRANSLATE_API_KEY || TRANSLATE_API_KEY === 'YOUR_ACTUAL_API_KEY_HERE')) {
            showToast(getText('translation_needed'));
            return;
        }
        
        currentLang = nextLang;
        document.getElementById('langFlag').textContent = flags[currentLang];
        document.getElementById('langCode').textContent = codes[currentLang];
        
        updateUITexts();
        
        if (currentLang !== 'ko') {
            console.log('번역 기능 테스트 시작...');
            translateText('안녕하세요', currentLang)
                .then(result => console.log('테스트 번역 결과:', result))
                .catch(error => console.error('테스트 번역 오류:', error));
        }
    }

    function openTextSearch() { 
        document.getElementById('searchResultsPage').classList.add('active'); 
        document.getElementById('searchInput').focus(); 
    }
    function closeSearchResults() { 
        document.getElementById('searchResultsPage').classList.remove('active'); 
    }
    function openBarcodeScanner() { 
        document.getElementById('scannerModal').classList.add('active'); 
        document.getElementById('scanResult').classList.remove('active'); 
        startScanning(); 
    }
    function closeScanner() { 
        stopScanning(); 
        document.getElementById('scannerModal').classList.remove('active'); 
    }
    function closeDetail() { 
        document.getElementById('detailPage').classList.remove('active'); 
    }
    function showToast(message) { 
        const toast = document.getElementById('toast'); 
        toast.textContent = message; 
        toast.classList.add('show'); 
        setTimeout(() => toast.classList.remove('show'), 3000); 
    }

    // --- API 호출 및 데이터 처리 함수 ---
    async function translateText(text, targetLang) {
        if (targetLang === 'ko' || !text || !TRANSLATE_API_KEY || TRANSLATE_API_KEY === 'YOUR_ACTUAL_API_KEY_HERE') {
            return text;
        }
        
        try {
            console.log('번역 시도:', { text: text.substring(0, 50), targetLang });
            
            const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${TRANSLATE_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: text, target: targetLang, source: 'ko' })
            });
            
            console.log('API 응답 상태:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error('API 오류 응답:', errorData);
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('번역 성공:', data);
            const translatedText = data.data?.translations?.[0]?.translatedText || text;
            console.log('최종 번역 결과:', translatedText);
            return translatedText;
            
        } catch (error) {
            console.error('번역 오류:', error);
            showToast(`번역 오류: ${error.message}`);
            return text;
        }
    }

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (query.length < 2) { 
            document.getElementById('resultsContainer').innerHTML = ''; 
            return; 
        }
        searchTimeout = setTimeout(() => searchProducts(query), 500);
    });

    async function searchProducts(query) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('searching')}</div>`;
        
        console.log('제품 검색 시작:', query);
        
        try {
            // 전체 제품 목록을 가져와서 클라이언트에서 필터링
            const originalUrl = `${FOOD_API_BASE}/${FOOD_API_KEY}/${SERVICE_ID}/json/1/200`;
            console.log('요청 URL:', originalUrl);
            
            const response = await fetch(PROXY_URL + encodeURIComponent(originalUrl));
            console.log('API 응답 상태:', response.status);
            
            if (!response.ok) {
                throw new Error(`네트워크 오류: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API 데이터 수신 완료');
            
            // 데이터 추출
            let allProducts = [];
            if (data.C005?.row) {
                allProducts = Array.isArray(data.C005.row) ? data.C005.row : [data.C005.row];
            }
            
            console.log('전체 제품 수:', allProducts.length);
            
            if (allProducts.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">😢</div>
                        <div>제품 데이터를 불러올 수 없습니다</div>
                    </div>`;
                return;
            }
            
            // 검색어로 필터링
            const searchTerm = query.toLowerCase().trim();
            const matchedProducts = allProducts.filter(product => {
                const productName = (product.PRDLST_NM || '').toLowerCase();
                const companyName = (product.BSSH_NM || '').toLowerCase();
                const productDesc = (product.PRDLST_DCNM || '').toLowerCase();
                
                return productName.includes(searchTerm) || 
                       companyName.includes(searchTerm) || 
                       productDesc.includes(searchTerm);
            });
            
            console.log(`"${query}" 검색 결과:`, matchedProducts.length + '개');
            
            if (matchedProducts.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <div>"${query}" 검색 결과가 없습니다</div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">
                            다른 키워드를 시도해보세요
                        </div>
                    </div>`;
                return;
            }
            
            // 검색 결과 표시 (최대 20개)
            const displayProducts = matchedProducts.slice(0, 20);
            
            container.innerHTML = displayProducts.map((product, index) => `
                <div class="result-card" onclick='showProductDetail(${JSON.stringify(product).replace(/'/g, "&apos;")})'>
                    <div class="result-name">
                        ${highlightSearchTerm(product.PRDLST_NM || '제품명 없음', query)}
                    </div>
                    <div class="result-desc">
                        ${product.PRDLST_DCNM || '식품'}
                    </div>
                    <div class="result-company">
                        ${highlightSearchTerm(product.BSSH_NM || '제조사 정보 없음', query)}
                    </div>
                    ${product.BAR_CD ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">바코드: ${product.BAR_CD}</div>` : ''}
                </div>
            `).join('');
            
        } catch (error) {
            console.error('검색 오류:', error);
            container.innerHTML = `
                <div class="loading" style="color: #e74c3c;">
                    <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                    검색 중 오류 발생<br>
                    <div style="font-size: 12px; margin-top: 10px; color: #666;">
                        ${error.message}
                    </div>
                </div>`;
        }
    }
    
    // 검색어 하이라이트 함수
    function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm || !text) return text;
        
        try {
            const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: #fff3cd; padding: 1px 2px;">$1</mark>');
        } catch (e) {
            return text;
        }
    }
    
    async function findProductByBarcode(barcode) {
        console.log('바코드 검색 시작:', barcode);
        
        // 바코드를 변수에 저장 (CORS 문제 해결을 위해 분리)
        const detectedBarcode = barcode;
        
        document.getElementById('barcodeNumber').textContent = detectedBarcode;
        document.getElementById('productFound').textContent = getText('searching_product');
        document.getElementById('scanResult').classList.add('active');
        
        try {
            // 바코드 API 요청 (CORS 우회를 위해 프록시 사용)
            const barcodeSearchUrl = `${FOOD_API_BASE}/${FOOD_API_KEY}/${SERVICE_ID}/json/1/50/BAR_CD=${detectedBarcode}`;
            console.log('바코드 검색 URL:', barcodeSearchUrl);
            
            const response = await fetch(PROXY_URL + encodeURIComponent(barcodeSearchUrl));
            console.log('바코드 API 응답 상태:', response.status);
            
            if (!response.ok) {
                throw new Error(`네트워크 오류: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('바코드 API 응답 데이터:', data);
            
            // API 응답 처리
            if (data.C005?.RESULT?.CODE === 'ERROR') {
                console.log('API 에러:', data.C005.RESULT.MSG);
                throw new Error(data.C005.RESULT.MSG || '바코드 검색 중 오류 발생');
            }
            
            // 제품 데이터 추출
            let foundProducts = [];
            if (data.C005?.row) {
                foundProducts = Array.isArray(data.C005.row) ? data.C005.row : [data.C005.row];
            }
            
            console.log('바코드로 찾은 제품 수:', foundProducts.length);
            
            if (foundProducts.length > 0) {
                const product = foundProducts[0];
                console.log('제품 발견:', product.PRDLST_NM);
                
                // 제품 발견 시 번역 처리
                try {
                    const productName = await translateText(product.PRDLST_NM || '제품', currentLang);
                    document.getElementById('productFound').innerHTML = `
                        <div style="color: #28a745; font-weight: bold; margin-bottom: 8px;">
                            ${productName} ${getText('product_found')}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            바코드: ${detectedBarcode}
                        </div>
                    `;
                    
                    // 2초 후 상세 화면으로 이동
                    setTimeout(() => {
                        console.log('상세 화면으로 이동 중...');
                        closeScanner();
                        showProductDetail(product);
                    }, 2000);
                    
                } catch (translateError) {
                    console.warn('번역 실패, 원본 이름 사용:', translateError);
                    document.getElementById('productFound').innerHTML = `
                        <div style="color: #28a745; font-weight: bold; margin-bottom: 8px;">
                            ${product.PRDLST_NM} ${getText('product_found')}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            바코드: ${detectedBarcode}
                        </div>
                    `;
                    
                    setTimeout(() => {
                        closeScanner();
                        showProductDetail(product);
                    }, 2000);
                }
                
           } else {
                console.log('제품을 찾을 수 없음');
                
                // 결과 아이콘을 에러로 변경
                document.querySelector('#scanResult .result-icon').textContent = '❌';
                
                // 즉시 토스트 경고 메시지 표시 (DOM 업데이트 전에 먼저)
                setTimeout(() => {
                    showToast(`등록되지 않은 제품입니다 (바코드: ${detectedBarcode})`);
                }, 100);
                
                document.getElementById('productFound').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">
                        ${getText('product_not_found')}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        바코드: ${detectedBarcode}
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 8px;">
                        등록되지 않은 제품입니다
                    </div>
                    <button onclick="requestProductAddition('${detectedBarcode}')" 
                            style="margin-top: 10px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        제품 등록 요청
                    </button>
                `;
                
                // 5초 후 자동으로 스캔 결과 화면 숨기고 다시 스캔 모드로
                setTimeout(() => {
                    console.log('제품 없음 - 자동으로 스캔 모드로 복귀');
                    document.getElementById('scanResult').classList.remove('active');
                    document.querySelector('#scanResult .result-icon').textContent = '✅'; // 아이콘 복원
                    restartScanning();
                }, 5000);
            }
            
        } catch (error) {
            console.error('바코드 검색 오류:', error);
            document.getElementById('productFound').innerHTML = `
                <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">
                    ${getText('error_occurred')}
                </div>
                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                    바코드: ${detectedBarcode}
                </div>
                <div style="font-size: 11px; color: #999; word-break: break-all;">
                    ${error.message}
                </div>
                <button onclick="retryBarcodeSearch('${detectedBarcode}')" 
                        style="margin-top: 10px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                    다시 시도
                </button>
            `;
            
            // 10초 후 스캔 결과 화면 숨기기
            setTimeout(() => {
                document.getElementById('scanResult').classList.remove('active');
            }, 10000);
        }
    }
    
    // 제품 등록 요청 함수
    function requestProductAddition(barcode) {
        console.log('제품 등록 요청:', barcode);
        showToast('제품 등록 요청이 접수되었습니다. 검토 후 추가될 예정입니다.');
        
        // 실제 구현 시 서버에 요청 전송
        const requestData = {
            barcode: barcode,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            language: currentLang
        };
        
        console.log('제품 등록 요청 데이터:', requestData);
        closeScanner();
    }
    
    // 바코드 재검색 함수
    function retryBarcodeSearch(barcode) {
        console.log('바코드 재검색:', barcode);
        document.getElementById('scanResult').classList.remove('active');
        findProductByBarcode(barcode);
    }
    
    async function showProductDetail(product) {
        console.log('제품 상세 화면 표시:', product);
        
        currentProduct = product;
        const detailPage = document.getElementById('detailPage');
        const detailContent = document.getElementById('detailContent');
        
        detailPage.classList.add('active');
        detailContent.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('loadingInfo')}</div>`;
        document.getElementById('detailHero').textContent = '🛍️';
        
        try {
            console.log('제품 정보 번역 시작...');
            
            const [pName, pDesc, pCompany, pAddr] = await Promise.all([
                translateText(product.PRDLST_NM || '제품명 없음', currentLang),
                translateText(product.PRDLST_DCNM || '', currentLang),
                translateText(product.BSSH_NM || '', currentLang),
                translateText(product.SITE_ADDR || '', currentLang)
            ]);
            
            console.log('번역 완료:', { pName, pDesc, pCompany, pAddr });
            
            detailContent.innerHTML = `
                <div class="detail-title">${pName}</div>
                <div class="detail-subtitle">${pDesc || getText('noResults')}</div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">${getText('manufacturer')}</div>
                        <div class="info-value">${pCompany || '-'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">${getText('expiry')}</div>
                        <div class="info-value">${product.POG_DAYCNT || '-'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">${getText('barcode')}</div>
                        <div class="info-value">${product.BAR_CD || '-'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">${getText('reportNumber')}</div>
                        <div class="info-value">${product.PRDLST_REPORT_NO || '-'}</div>
                    </div>
                </div>
                
                <div class="section-title">${getText('manufacturerInfo')}</div>
                <div style="font-size: 14px; color: #636E72; line-height: 1.6;">
                    ${pAddr || getText('noAddress')}
                </div>
                
                ${product.LCNS_NO ? `
                    <div class="section-title">허가번호</div>
                    <div style="font-size: 14px; color: #636E72; font-family: monospace;">
                        ${product.LCNS_NO}
                    </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                    💡 이 정보는 식품안전나라 공공데이터를 기반으로 제공됩니다.
                </div>
            `;
            
        } catch (error) {
            console.error('제품 상세 정보 로딩 오류:', error);
            detailContent.innerHTML = `
                <div class="no-results" style="padding: 40px 20px;">
                    <div class="no-results-icon" style="font-size: 48px;">⚠️</div>
                    <h3 style="font-size: 18px; margin-bottom: 12px;">${getText('errorLoading')}</h3>
                    <p style="color: #c0392b; background: #fbeae5; padding: 12px; border-radius: 8px; font-family: monospace; word-break: break-all; font-size: 12px;">
                        ${error.message}
                    </p>
                    <p style="margin-top: 20px; font-size: 14px; color: #636E72;">
                        ${getText('checkApiSettings')}
                    </p>
                    <button onclick="closeDetail()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        돌아가기
                    </button>
                </div>
            `;
        }
    }

    // --- 바코드 스캐너 관련 함수 (개선된 버전) ---
    let isScanning = false;
    let scanLocked = false;
    let detectionHistory = [];
    const STABLE_COUNT = 3;

    // EAN-13 바코드 정규화
    function normalizeEAN13(str) {
        const digits = (str || '').replace(/\D/g, '');
        return digits.length >= 13 ? digits.slice(0, 13) : digits.length >= 8 ? digits : null;
    }

    // EAN-13 체크섬 검증
    function isValidEAN13(code) {
        if (!/^\d{13}$/.test(code)) return false;
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            sum += parseInt(code[i], 10) * (i % 2 ? 3 : 1);
        }
        return (10 - (sum % 10)) % 10 === parseInt(code[12], 10);
    }

    // 바코드 검출 핸들러 (안정성 개선)
    function onBarcodeDetected(result) {
        if (scanLocked) return;
        
        const raw = result.codeResult?.code;
        const normalized = normalizeEAN13(raw);
        if (!normalized) return;
        
        // EAN-13 검증 (13자리인 경우만)
        if (normalized.length === 13 && !isValidEAN13(normalized)) return;

        detectionHistory.push(normalized);
        const recent = detectionHistory.slice(-STABLE_COUNT);
        const stable = recent.length === STABLE_COUNT && recent.every(v => v === recent[0]);
        
        if (!stable) return;

        // 안정된 바코드 검출됨
        scanLocked = true;
        console.log('안정된 바코드 검출:', normalized);
        
        // 진동 피드백
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }
        
        stopScanning();
        findProductByBarcode(normalized);
    }
    
    function startScanning() {
        if (isScanning) return;
        
        console.log('바코드 스캐닝 시작');
        
        // 상태 초기화
        scanLocked = false;
        detectionHistory = [];
        
        // Quagga 라이브러리 확인
        if (typeof Quagga === 'undefined') {
            console.error('Quagga 라이브러리가 로드되지 않음');
            showToast('바코드 스캐너를 사용할 수 없습니다. 페이지를 새로고침해보세요.');
            fallbackToManualInput();
            return;
        }
        
        Quagga.init({
            inputStream: { 
                name: "Live", 
                type: "LiveStream", 
                target: document.querySelector('#scanner-viewport'), 
                constraints: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    focusMode: "continuous"
                },
                area: { top: "15%", right: "15%", left: "15%", bottom: "15%" }
            },
            locator: { patchSize: "medium", halfSample: true },
            numOfWorkers: navigator.hardwareConcurrency || 4,
            decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader"], multiple: false },
            locate: true
        }, (err) => {
            if (err) { 
                console.error('Quagga 초기화 오류:', err); 
                showToast('카메라를 사용할 수 없습니다: ' + err.message); 
                fallbackToManualInput();
                return; 
            }
            
            console.log('Quagga 초기화 성공');
            Quagga.start(); 
            isScanning = true;
            
            // 이벤트 핸들러 등록
            Quagga.onDetected(onBarcodeDetected);
        });
        
        Quagga.onProcessed((result) => {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;
            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(box => box !== result.box).forEach(box => 
                        Quagga.ImageDebug.drawPath(box, {x:0,y:1}, drawingCtx, {color:"green",lineWidth:2})
                    );
                }
                if (result.box) Quagga.ImageDebug.drawPath(result.box, {x:0,y:1}, drawingCtx, {color:"#00F",lineWidth:2});
                if (result.codeResult && result.codeResult.code) 
                    Quagga.ImageDebug.drawPath(result.line, {x:'x',y:'y'}, drawingCtx, {color:'red',lineWidth:3});
            }
        });
    }
    
    function stopScanning() { 
        if (isScanning && typeof Quagga !== 'undefined') { 
            Quagga.offProcessed(); 
            Quagga.offDetected(onBarcodeDetected); 
            Quagga.stop(); 
            isScanning = false;
            console.log('바코드 스캐닝 중지');
        } 
    }
    
    // 카메라 사용 불가 시 수동 입력으로 대체
    function fallbackToManualInput() {
        closeScanner();
        showToast('카메라를 사용할 수 없어 수동 입력 모드로 전환합니다.');
        
        setTimeout(() => {
            const manualInput = prompt('바코드 번호를 직접 입력해주세요:');
            if (manualInput && manualInput.trim().length >= 8) {
                findProductByBarcode(manualInput.trim());
            }
        }, 1000);
    }
    
    function restartScanning() { 
        document.getElementById('scanResult').classList.remove('active'); 
        scanLocked = false;
        detectionHistory = [];
        startScanning(); 
    }
    
    function searchByManualBarcode() { 
        const barcode = document.getElementById('manualBarcode').value.trim(); 
        if (barcode.length < 8) { 
            showToast(getText('invalid_barcode')); 
            return; 
        }
        
        const normalized = normalizeEAN13(barcode);
        if (!normalized) {
            showToast('올바른 바코드 형식이 아닙니다');
            return;
        }
        
        stopScanning(); 
        findProductByBarcode(normalized); 
    }
</script>
</body>
</html>
