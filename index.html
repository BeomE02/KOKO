<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KOKO - Korean Product Guide</title>
    <style>
        /* --- ê¸°ë³¸ & ë””ìì¸ ì‹œìŠ¤í…œ --- */
        :root {
            --primary-black: #1d1d1f;
            --primary-white: #ffffff;
            --accent-gray: #6e6e73;
            --light-gray: #f5f5f7;
            --medium-gray: #d2d2d7;
            --system-blue: #007aff;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            background: var(--light-gray);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-white);
            color: var(--primary-black);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            max-width: 800px; /* ëª¨ë°”ì¼ ì¤‘ì‹¬ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }
        
        /* --- ìŠ¤í”Œë˜ì‹œ í™”ë©´ --- */
        .splash-screen {
            position: fixed; inset: 0; background: var(--primary-white);
            z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease-in-out;
        }
        .splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-logo { font-size: 60px; margin-bottom: 1rem; }
        .splash-title { font-size: 2rem; font-weight: 600; letter-spacing: -0.02em; }

        /* --- í—¤ë” --- */
        .header {
            padding: 1rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid var(--medium-gray);
        }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .lang-btn {
            padding: 0.5rem 1rem; background: var(--light-gray); border: none;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 8px;
        }

        /* --- í˜ì´ì§€ ì „í™˜ --- */
        .page-container {
            position: relative;
            overflow: hidden;
        }
        .page {
            min-height: calc(100vh - 61px);
            padding: 2rem 1.5rem;
            position: absolute; top: 0; left: 0; width: 100%;
            background-color: var(--primary-white);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .page.active { transform: translateX(0); z-index: 10; }
        .page.exiting { transform: translateX(-100%); z-index: 5; }
        .page.exiting-reverse { transform: translateX(100%); z-index: 5;}
        
        #home { position: relative; } /* ì²« í˜ì´ì§€ë§Œ position relativeë¡œ */

        /* --- í™ˆ í˜ì´ì§€ --- */
        .welcome-title { font-size: 2rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.5rem; }
        .welcome-subtitle { font-size: 1rem; color: var(--accent-gray); margin-bottom: 2.5rem; }
        .search-option-card {
            padding: 1.5rem; background: var(--light-gray); border-radius: 12px;
            margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;
            transition: transform 0.2s;
        }
        .search-option-card:active { transform: scale(0.98); }
        .option-icon { font-size: 1.8rem; }
        .option-title { font-size: 1.1rem; font-weight: 600; }
        .option-desc { font-size: 0.9rem; color: var(--accent-gray); }

        /* --- ê²€ìƒ‰ í˜ì´ì§€ --- */
        .search-header {
            display: flex; align-items: center; gap: 0.5rem;
            padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--medium-gray);
        }
        .back-btn { font-size: 1.5rem; background: none; border: none; padding: 0.5rem; }
        .search-input {
            width: 100%; border: none; background: transparent;
            font-size: 1.2rem; font-weight: 600; outline: none;
        }
        .result-card {
            padding: 1rem 0; border-bottom: 1px solid var(--light-gray);
        }
        .result-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .result-desc { font-size: 0.9rem; color: var(--accent-gray); }

        /* --- ìƒì„¸ í˜ì´ì§€ --- */
        .detail-header {
            display: flex; align-items: center; gap: 0.5rem;
            padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--medium-gray);
        }
        .detail-title { font-size: 1.8rem; font-weight: 700; }
        .info-grid { display: flex; flex-direction: column; gap: 1.5rem; }
        .info-item { border-left: 3px solid var(--system-blue); padding-left: 1rem; }
        .info-label { font-size: 0.9rem; color: var(--accent-gray); }
        .info-value { font-size: 1.1rem; font-weight: 500; word-break: break-all; }

        /* --- ë¡œë”© & ìƒíƒœ ë©”ì‹œì§€ --- */
        .status-message { text-align: center; padding: 4rem 0; color: var(--accent-gray); }
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--medium-gray);
            border-top-color: var(--primary-black); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ëª¨ë‹¬ --- */
        .scanner-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 2000; display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .scanner-modal.active { opacity: 1; pointer-events: all; }
        .scanner-content {
            background: var(--primary-white);
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .scanner-modal.active .scanner-content { transform: translateY(0); }

        .scanner-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); }
        .scanner-title { font-size: 1.1rem; font-weight: 600; }
        .close-scanner-btn { font-size: 1.5rem; background: none; border: none; }
        .scanner-viewport-container { position: relative; background: #000; height: 250px; }
        #scanner-viewport video, #scanner-viewport canvas { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
        .scan-guide { width: 80%; max-width: 300px; height: 80px; border: 2px solid rgba(255,255,255,0.7); border-radius: 12px; }
        .manual-input-area { padding: 1.5rem; }
        .barcode-input {
            width: 100%; padding: 1rem; border: 1px solid var(--medium-gray); border-radius: 8px;
            font-size: 1rem; text-align: center; margin-bottom: 1rem;
        }
        .search-barcode-btn {
            width: 100%; padding: 1rem; background: var(--primary-black); color: var(--primary-white);
            border: none; border-radius: 8px; font-size: 1rem; font-weight: 600;
        }

        /* --- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ --- */
        .toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: var(--primary-black); color: var(--primary-white);
            padding: 12px 20px; border-radius: 8px; font-size: 14px;
            z-index: 10001; transition: bottom 0.4s ease-in-out;
        }
        .toast.show { bottom: 2rem; }
    </style>
</head>
<body>
    <div class="splash-screen" id="splash">
        <div class="splash-logo">ğŸ›ï¸</div>
        <div class="splash-title">KOKO</div>
    </div>

    <div class="header">
        <div class="logo">KOKO</div>
        <button class="lang-btn" onclick="toggleLanguage()">
            <span id="langFlag">ğŸ‡°ğŸ‡·</span>
            <span id="langCode">KO</span>
        </button>
    </div>

    <main class="page-container">
        <div class="page active" id="home">
            <h1 class="welcome-title" id="appTitle">í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”</h1>
            <p class="welcome-subtitle" id="appSubtitle">ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <div class="search-options">
                <div class="search-option-card" onclick="showPage('searchResults')">
                    <div class="option-icon">ğŸ”</div>
                    <div>
                        <h3 class="option-title" id="searchByName">ìƒí’ˆëª… ê²€ìƒ‰</h3>
                        <p class="option-desc" id="searchByNameDesc">ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°</p>
                    </div>
                </div>
                <div class="search-option-card" onclick="openBarcodeScanner()">
                    <div class="option-icon">ğŸ“Š</div>
                    <div>
                        <h3 class="option-title" id="scanBarcode">ë°”ì½”ë“œ ìŠ¤ìº”</h3>
                        <p class="option-desc" id="scanBarcodeDesc">ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="searchResults">
            <div class="search-header">
                <button class="back-btn" onclick="goBack()">â†</button>
                <input type="text" class="search-input" id="searchInput" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">
            </div>
            <div id="resultsContainer"></div>
        </div>

        <div class="page" id="detail">
            <div class="detail-header">
                <button class="back-btn" onclick="goBack()">â†</button>
                <h2 id="productDetailTitle" style="font-size: 1.2rem; font-weight: 600;">ìƒí’ˆ ìƒì„¸ ì •ë³´</h2>
            </div>
            <div class="detail-content" id="detailContent"></div>
        </div>
    </main>

    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-content">
            <div class="scanner-header">
                <h3 class="scanner-title" id="barcodeScanTitle">ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h3>
                <button class="close-scanner-btn" onclick="closeScanner()">Ã—</button>
            </div>
            <div id="scanner-status-container" style="display: none;">
                <div class="status-message"><div class="spinner"></div></div>
            </div>
            <div class="scanner-viewport-container" id="scanner-viewport-wrapper">
                <div id="scanner-viewport"></div>
                <div class="scan-overlay"><div class="scan-guide"></div></div>
            </div>
            <div class="manual-input-area" id="manual-input-wrapper">
                <input type="number" class="barcode-input" id="manualBarcode" placeholder="ë°”ì½”ë“œ ë²ˆí˜¸ ì§ì ‘ ì…ë ¥">
                <button class="search-barcode-btn" id="searchBarcodeBtn" onclick="searchByManualBarcode()">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        // --- API & ì„¤ì • ---
        const FOOD_API_KEY = 'c320de96f22d4183bd13';
        // ğŸš¨ ë³´ì•ˆ ì£¼ì˜: ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” API í‚¤ë¥¼ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì— ë…¸ì¶œí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
        // ì´ ì½”ë“œëŠ” ë°ëª¨ìš©ì´ë©°, ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì„œë²„ë¥¼ í†µí•´ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
        const TRANSLATE_API_KEY = 'AIzaSyArr1P7f6JuAL8Xz8ECiHi8WkfbNRn4Z7I';
        const PROXY_URL = 'https://api.allorigins.win/raw?url=';
        const FOOD_API_BASE = `https://openapi.foodsafetykorea.go.kr/api/${FOOD_API_KEY}/C005/json`;

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentLang = 'ko';
        let searchCache = null;
        let pageHistory = ['home'];

        // ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸ (ìƒëµ... ì´ì „ ì½”ë“œì™€ ë™ì¼)
        const translations = {
            ko: { appTitle: 'í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”', appSubtitle: 'ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”', searchByName: 'ìƒí’ˆëª… ê²€ìƒ‰', searchByNameDesc: 'ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°', scanBarcode: 'ë°”ì½”ë“œ ìŠ¤ìº”', scanBarcodeDesc: 'ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°', searchPlaceholder: 'ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”...', productDetail: 'ìƒí’ˆ ìƒì„¸ ì •ë³´', manufacturer: 'ì œì¡°ì‚¬', expiry: 'ì†Œë¹„ê¸°í•œ', barcode: 'ë°”ì½”ë“œ', reportNumber: 'í’ˆëª©ë³´ê³ ë²ˆí˜¸', searching: 'ê²€ìƒ‰ ì¤‘...', noResults: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', loadingInfo: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', errorLoading: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ', barcodeTitle: 'ë°”ì½”ë“œ ìŠ¤ìºë„ˆ', search: 'ê²€ìƒ‰', product_found: 'ìƒí’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!', product_not_found: 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', camera_error: 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', invalid_barcode: 'ìœ íš¨í•œ ë°”ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', translation_needed: 'ë²ˆì—­ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
            en: { appTitle: 'Find Korean<br>Products Easily', appSubtitle: 'Choose your search method', searchByName: 'Search by Name', searchByNameDesc: 'Find products using their name', scanBarcode: 'Scan Barcode', scanBarcodeDesc: 'Find products with their barcode', searchPlaceholder: 'Enter product name...', productDetail: 'Product Details', manufacturer: 'Manufacturer', expiry: 'Shelf Life', barcode: 'Barcode', reportNumber: 'Report No.', searching: 'Searching...', noResults: 'No search results found', loadingInfo: 'Loading information...', errorLoading: 'Error loading details', barcodeTitle: 'Barcode Scanner', search: 'Search', product_found: 'Product Found!', product_not_found: 'Product not found.', camera_error: 'Could not access camera.', invalid_barcode: 'Please enter a valid barcode.', translation_needed: 'API key is required for translation.' },
            ja: { appTitle: 'éŸ“å›½è£½å“ã‚’<br>ç°¡å˜ã«è¦‹ã¤ã‘ã‚ˆã†', appSubtitle: 'æ¤œç´¢æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„', searchByName: 'å•†å“åã§æ¤œç´¢', searchByNameDesc: 'å•†å“åã§è£½å“ã‚’æ¤œç´¢', scanBarcode: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³', scanBarcodeDesc: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§è£½å“ã‚’æ¤œç´¢', searchPlaceholder: 'å•†å“åã‚’å…¥åŠ›...', productDetail: 'å•†å“è©³ç´°', manufacturer: 'è£½é€ ç¤¾', expiry: 'æ¶ˆè²»æœŸé™', barcode: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰', reportNumber: 'å“ç›®å ±å‘Šç•ªå·', searching: 'æ¤œç´¢ä¸­...', noResults: 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“', loadingInfo: 'æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', errorLoading: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', barcodeTitle: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼', search: 'æ¤œç´¢', product_found: 'è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼', product_not_found: 'è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', camera_error: 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', invalid_barcode: 'æœ‰åŠ¹ãªãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', translation_needed: 'ç¿»è¨³ã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™' }
        };
        const getText = (key) => translations[currentLang][key] || key;
        
        // --- ì´ˆê¸°í™” ë° UI ì´ë²¤íŠ¸ ---
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('splash').classList.add('fade-out');
            }, 1500);

            // ë°ì´í„° ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
            fetchAllProducts();

            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (query.length < 2) {
                    document.getElementById('resultsContainer').innerHTML = '';
                    return;
                }
                searchTimeout = setTimeout(() => searchProducts(query), 300);
            });
            updateUITexts();
        });
        
        // --- í˜ì´ì§€ ë° ëª¨ë‹¬ ê´€ë¦¬ (ê°œì„ ëœ ë²„ì „) ---
        function showPage(pageId) {
            const currentPageId = pageHistory[pageHistory.length - 1];
            if (currentPageId === pageId) return;

            const currentPage = document.getElementById(currentPageId);
            const newPage = document.getElementById(pageId);

            currentPage.classList.add('exiting');
            newPage.classList.remove('exiting-reverse');
            newPage.classList.add('active');

            pageHistory.push(pageId);

            setTimeout(() => {
                currentPage.classList.remove('active', 'exiting');
            }, 400);

            if (pageId === 'searchResults') {
                document.getElementById('searchInput').focus();
            }
        }

        function goBack() {
            if (pageHistory.length <= 1) return;

            const currentPageId = pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];

            const currentPage = document.getElementById(currentPageId);
            const previousPage = document.getElementById(previousPageId);
            
            currentPage.classList.add('exiting-reverse');
            previousPage.classList.remove('exiting');
            previousPage.classList.add('active');
            
            setTimeout(() => {
                currentPage.classList.remove('active', 'exiting-reverse');
            }, 400);
        }

        function openBarcodeScanner() { document.getElementById('scannerModal').classList.add('active'); startScanning(); }
        function closeScanner() { stopScanning(); document.getElementById('scannerModal').classList.remove('active'); }

        // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function updateUITexts() {
            document.getElementById('appTitle').innerHTML = getText('appTitle');
            // ... (ë‚˜ë¨¸ì§€ UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸)
        }

        function toggleLanguage() {
            const langs = ['ko', 'en', 'ja'];
            const flags = { ko: 'ğŸ‡°ğŸ‡·', en: 'ğŸ‡ºğŸ‡¸', ja: 'ğŸ‡¯ğŸ‡µ' };
            const codes = { ko: 'KO', en: 'EN', ja: 'JP' };
            
            currentLang = langs[(langs.indexOf(currentLang) + 1) % langs.length];
            
            document.getElementById('langFlag').textContent = flags[currentLang];
            document.getElementById('langCode').textContent = codes[currentLang];
            updateUITexts();
        }

        async function fetchAllProducts() {
            if (searchCache) return searchCache;
            const url = `${FOOD_API_BASE}/1/1000`; // ìµœëŒ€ 1000ê°œ ë°ì´í„° ìºì‹±
            try {
                const response = await fetch(PROXY_URL + encodeURIComponent(url));
                const data = await response.json();
                searchCache = data.C005?.row || [];
            } catch (error) {
                console.error("Error pre-fetching products:", error);
                searchCache = [];
            }
        }

        async function searchProducts(query) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="status-message"><div class="spinner"></div>${getText('searching')}</div>`;

            const allProducts = await fetchAllProducts();
            const lowerCaseQuery = query.toLowerCase();
            
            const results = allProducts.filter(p => 
                (p.PRDLST_NM?.toLowerCase().includes(lowerCaseQuery)) ||
                (p.BSSH_NM?.toLowerCase().includes(lowerCaseQuery))
            ).slice(0, 20);

            if (results.length === 0) {
                container.innerHTML = `<div class="status-message">${getText('noResults')}</div>`;
                return;
            }

            container.innerHTML = results.map(product => `
                <div class="result-card" onclick='showProductDetail(${JSON.stringify(product)})'>
                    <h3 class="result-name">${product.PRDLST_NM}</h3>
                    <p class="result-desc">${product.BSSH_NM}</p>
                </div>
            `).join('');
        }
        
        async function findProductByBarcode(barcode) {
            const statusContainer = document.getElementById('scanner-status-container');
            const viewportWrapper = document.getElementById('scanner-viewport-wrapper');
            const manualWrapper = document.getElementById('manual-input-wrapper');

            statusContainer.style.display = 'block';
            viewportWrapper.style.display = 'none';
            manualWrapper.style.display = 'none';

            const url = `${FOOD_API_BASE}/1/5/BAR_CD=${barcode}`;
            try {
                const response = await fetch(PROXY_URL + encodeURIComponent(url));
                const data = await response.json();
                if (data.C005?.row) {
                    const product = Array.isArray(data.C005.row) ? data.C005.row[0] : data.C005.row;
                    showToast(getText('product_found'));
                    closeScanner();
                    showProductDetail(product);
                } else {
                    showToast(getText('product_not_found'));
                    closeScanner();
                }
            } catch (error) {
                showToast("Error during barcode search.");
                closeScanner();
            } finally {
                 setTimeout(() => { // UI ë³µì›
                    statusContainer.style.display = 'none';
                    viewportWrapper.style.display = 'block';
                    manualWrapper.style.display = 'block';
                }, 500);
            }
        }
        
        async function showProductDetail(productData) {
            const product = JSON.parse(JSON.stringify(productData));
            const content = document.getElementById('detailContent');
            showPage('detail');
            content.innerHTML = `<div class="status-message"><div class="spinner"></div>${getText('loadingInfo')}</div>`;

            const [pName, pCompany] = await Promise.all([
                translateText(product.PRDLST_NM || ''),
                translateText(product.BSSH_NM || ''),
            ]);

            content.innerHTML = `
                <h1 class="detail-title">${pName}</h1>
                <div class="info-grid">
                    <div class="info-item">
                        <p class="info-label">${getText('manufacturer')}</p>
                        <p class="info-value">${pCompany || '-'}</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">${getText('expiry')}</p>
                        <p class="info-value">${product.POG_DAYCNT || '-'}</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">${getText('barcode')}</p>
                        <p class="info-value">${product.BAR_CD || '-'}</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">${getText('reportNumber')}</p>
                        <p class="info-value">${product.PRDLST_REPORT_NO || '-'}</p>
                    </div>
                </div>
            `;
        }
        
        async function translateText(text) {
             if (currentLang === 'ko' || !text || TRANSLATE_API_KEY.length < 20) return text;
            try {
                const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${TRANSLATE_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: text, target: currentLang, source: 'ko' })
                });
                const data = await response.json();
                return data.data.translations[0].translatedText;
            } catch (error) { return text; }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ---
        let isScanning = false;
        function startScanning() {
            if(isScanning) return;
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: '#scanner-viewport', constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader"] },
            }, (err) => {
                if (err) { showToast(getText('camera_error')); return; }
                Quagga.start();
                isScanning = true;
            });
            Quagga.onDetected(onBarcodeDetected);
        }

        function stopScanning() {
            if(isScanning) { Quagga.offDetected(onBarcodeDetected); Quagga.stop(); isScanning = false; }
        }

        const onBarcodeDetected = Quagga.debounce((result) => {
            stopScanning();
            findProductByBarcode(result.codeResult.code);
        }, 500);
        
        function searchByManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if(barcode.length < 8) { showToast(getText('invalid_barcode')); return; }
            findProductByBarcode(barcode);
        }
    </script>
</body>
</html>
